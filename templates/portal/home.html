{% extends 'portal/base.html' %}
{% load i18n %}

{% block active_nav %}home{% endblock %}
{% block page_title %}{% trans "Dashboard" %}{% endblock %}

{% block content %}
<!-- Stats Row -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ active_vehicles|default:'0' }}</div>
            <div class="stat-label">{% trans "Active Vehicles" %}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ bookings_this_month|default:'0' }}</div>
            <div class="stat-label">{% trans "Bookings This Month" %}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ revenue_this_month|default:'0'|floatformat:2 }} <small>MAD</small></div>
            <div class="stat-label">{% trans "Revenue This Month" %}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ pending_bookings|default:'0' }}</div>
            <div class="stat-label">{% trans "Pending Bookings" %}</div>
        </div>
    </div>
</div>

<!-- Bookings Chart -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>{% trans "Bookings - Last 30 Days" %}</span>
    </div>
    <div class="card-body">
        <canvas id="bookingsChart" height="80"></canvas>
    </div>
</div>

<!-- Recent Bookings -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>{% trans "Recent Bookings" %}</span>
        <a href="{% url 'portal:booking_list' %}" class="btn btn-sm btn-outline-primary">{% trans "View All" %}</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>{% trans "Ref" %}</th>
                        <th>{% trans "Customer" %}</th>
                        <th>{% trans "Vehicle" %}</th>
                        <th>{% trans "Pickup Date" %}</th>
                        <th>{% trans "Return Date" %}</th>
                        <th>{% trans "Total" %}</th>
                        <th>{% trans "Status" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in recent_bookings %}
                    <tr>
                        <td>
                            <a href="{% url 'portal:booking_detail' booking.pk %}">{{ booking.booking_ref }}</a>
                        </td>
                        <td>{{ booking.customer_name }}</td>
                        <td>{{ booking.vehicle.name|default:'' }}</td>
                        <td>{{ booking.pickup_date }}</td>
                        <td>{{ booking.return_date }}</td>
                        <td>{{ booking.total_price|floatformat:2 }} MAD</td>
                        <td>
                            {% if booking.status == 'pending' %}
                                <span class="badge bg-warning">{% trans "Pending" %}</span>
                            {% elif booking.status == 'confirmed' %}
                                <span class="badge bg-info">{% trans "Confirmed" %}</span>
                            {% elif booking.status == 'active' %}
                                <span class="badge bg-primary">{% trans "Active" %}</span>
                            {% elif booking.status == 'completed' %}
                                <span class="badge bg-success">{% trans "Completed" %}</span>
                            {% elif booking.status == 'cancelled' %}
                                <span class="badge bg-danger">{% trans "Cancelled" %}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ booking.get_status_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">{% trans "No bookings yet." %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-3">
    <div class="col-md-6">
        <a href="{% url 'portal:vehicle_create' %}" class="btn btn-primary w-100 py-3">
            <i class="bi bi-plus-circle me-2"></i>{% trans "Add Vehicle" %}
        </a>
    </div>
    <div class="col-md-6">
        <a href="{% url 'portal:booking_list' %}" class="btn btn-outline-primary w-100 py-3">
            <i class="bi bi-list-check me-2"></i>{% trans "View Bookings" %}
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = {{ chart_data|safe }};
    const ctx = document.getElementById('bookingsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: '{% trans "Bookings" %}',
                data: chartData.values,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                },
            },
        },
    });
});
</script>
{% endblock %}
