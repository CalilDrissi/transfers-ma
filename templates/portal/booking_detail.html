{% extends 'portal/base.html' %}
{% load i18n %}

{% block active_nav %}bookings{% endblock %}
{% block page_title %}{% trans "Booking" %} {{ booking.booking_ref }}{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Left Column: Booking Info -->
    <div class="col-lg-8">
        <!-- Customer Details -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-person me-2"></i>{% trans "Customer Details" %}
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Name" %}</div>
                        <div class="fw-semibold">{{ booking.customer_name }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Email" %}</div>
                        <div>{{ booking.customer_email }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Phone" %}</div>
                        <div>{{ booking.customer_phone }}</div>
                    </div>
                    {% if booking.driver_license_number %}
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "License Number" %}</div>
                        <div>{{ booking.driver_license_number }}</div>
                    </div>
                    {% endif %}
                    {% if booking.driver_license_expiry %}
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "License Expiry" %}</div>
                        <div>{{ booking.driver_license_expiry }}</div>
                    </div>
                    {% endif %}
                    {% if booking.flight_number %}
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Flight Number" %}</div>
                        <div>{{ booking.flight_number }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Vehicle Details -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-car-front me-2"></i>{% trans "Vehicle Details" %}
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Vehicle" %}</div>
                        <div class="fw-semibold">{{ booking.vehicle.name|default:'' }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "Category" %}</div>
                        <div>{{ booking.vehicle.category.name|default:'' }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">{% trans "License Plate" %}</div>
                        <div><code>{{ booking.vehicle.license_plate|default:'-' }}</code></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dates & Locations -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-calendar3 me-2"></i>{% trans "Dates & Locations" %}
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-muted small">{% trans "Pickup Date" %}</div>
                        <div class="fw-semibold">{{ booking.pickup_date }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">{% trans "Return Date" %}</div>
                        <div class="fw-semibold">{{ booking.return_date }}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">{% trans "Total Days" %}</div>
                        <div class="fw-semibold">{{ booking.total_days }}</div>
                    </div>
                    {% if booking.actual_return_date %}
                    <div class="col-md-3">
                        <div class="text-muted small">{% trans "Actual Return" %}</div>
                        <div class="fw-semibold">{{ booking.actual_return_date }}</div>
                    </div>
                    {% endif %}
                    {% if booking.pickup_location %}
                    <div class="col-md-6">
                        <div class="text-muted small">{% trans "Pickup Location" %}</div>
                        <div>{{ booking.pickup_location }}</div>
                    </div>
                    {% endif %}
                    {% if booking.dropoff_location %}
                    <div class="col-md-6">
                        <div class="text-muted small">{% trans "Dropoff Location" %}</div>
                        <div>{{ booking.dropoff_location }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pricing Breakdown -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-receipt me-2"></i>{% trans "Pricing Breakdown" %}
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">{% trans "Vehicle" %} ({{ booking.daily_rate|floatformat:2 }} &times; {{ booking.total_days }} {% trans "days" %})</td>
                            <td class="text-end">{{ booking.vehicle_total|floatformat:2 }} MAD</td>
                        </tr>
                        {% if booking.insurance_total %}
                        <tr>
                            <td class="text-muted">{% trans "Insurance" %}{% if booking.insurance %} ({{ booking.insurance.name }}){% endif %}</td>
                            <td class="text-end">{{ booking.insurance_total|floatformat:2 }} MAD</td>
                        </tr>
                        {% endif %}
                        {% if booking.extras_total %}
                        <tr>
                            <td class="text-muted">{% trans "Extras" %}</td>
                            <td class="text-end">{{ booking.extras_total|floatformat:2 }} MAD</td>
                        </tr>
                        {% endif %}
                        {% if booking.delivery_fee %}
                        <tr>
                            <td class="text-muted">{% trans "Delivery Fee" %}</td>
                            <td class="text-end">{{ booking.delivery_fee|floatformat:2 }} MAD</td>
                        </tr>
                        {% endif %}
                        <tr class="border-top">
                            <td class="fw-bold">{% trans "Total Price" %}</td>
                            <td class="text-end fw-bold">{{ booking.total_price|floatformat:2 }} MAD</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Commission Breakdown -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-percent me-2"></i>{% trans "Commission Breakdown" %}
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">{% trans "Total Price" %}</td>
                            <td class="text-end">{{ booking.total_price|floatformat:2 }} MAD</td>
                        </tr>
                        <tr>
                            <td class="text-muted">{% trans "Commission Rate" %}</td>
                            <td class="text-end">{{ booking.commission_rate|floatformat:2 }}%</td>
                        </tr>
                        <tr>
                            <td class="text-muted">{% trans "Commission Amount" %}</td>
                            <td class="text-end text-danger">-{{ booking.commission_amount|floatformat:2 }} MAD</td>
                        </tr>
                        <tr class="border-top">
                            <td class="fw-bold">{% trans "Net Payout" %}</td>
                            <td class="text-end fw-bold text-success">{{ booking.company_payout_amount|floatformat:2 }} MAD</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Booked Extras -->
        {% if booking.booked_extras.all %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-plus-square me-2"></i>{% trans "Booked Extras" %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{% trans "Extra" %}</th>
                            <th>{% trans "Qty" %}</th>
                            <th>{% trans "Price/Day" %}</th>
                            <th>{% trans "Total" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for be in booking.booked_extras.all %}
                        <tr>
                            <td>{{ be.extra.name|default:'â€”' }}</td>
                            <td>{{ be.quantity }}</td>
                            <td>{{ be.price_per_day|floatformat:2 }} MAD</td>
                            <td>{{ be.total|floatformat:2 }} MAD</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Company Notes -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-sticky me-2"></i>{% trans "Company Notes" %}
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'portal:booking_detail' booking.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_company_notes">
                    <textarea name="company_notes" class="form-control mb-2" rows="3" placeholder="{% trans 'Internal notes about this booking...' %}">{{ booking.company_notes|default:'' }}</textarea>
                    <button type="submit" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-save me-1"></i>{% trans "Save Notes" %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column: Actions + Timeline -->
    <div class="col-lg-4">
        <!-- Status -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-flag me-2"></i>{% trans "Status" %}
            </div>
            <div class="card-body text-center">
                {% if booking.status == 'pending' %}
                    <span class="badge bg-warning fs-6 px-3 py-2">{% trans "Pending" %}</span>
                {% elif booking.status == 'confirmed' %}
                    <span class="badge bg-info fs-6 px-3 py-2">{% trans "Confirmed" %}</span>
                {% elif booking.status == 'active' %}
                    <span class="badge bg-primary fs-6 px-3 py-2">{% trans "Active" %}</span>
                {% elif booking.status == 'completed' %}
                    <span class="badge bg-success fs-6 px-3 py-2">{% trans "Completed" %}</span>
                {% elif booking.status == 'cancelled' %}
                    <span class="badge bg-danger fs-6 px-3 py-2">{% trans "Cancelled" %}</span>
                {% else %}
                    <span class="badge bg-secondary fs-6 px-3 py-2">{{ booking.get_status_display }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>{% trans "Actions" %}
            </div>
            <div class="card-body d-grid gap-2">
                {% if booking.status == 'pending' %}
                <form method="post" action="{% url 'portal:booking_detail' booking.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="confirm_booking">
                    <button type="submit" class="btn btn-info w-100">
                        <i class="bi bi-check-circle me-1"></i>{% trans "Confirm Booking" %}
                    </button>
                </form>
                {% endif %}

                {% if booking.status == 'confirmed' %}
                <form method="post" action="{% url 'portal:booking_detail' booking.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="start_rental">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-play-circle me-1"></i>{% trans "Start Rental" %}
                    </button>
                </form>
                {% endif %}

                {% if booking.status == 'active' %}
                <form method="post" action="{% url 'portal:booking_detail' booking.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="complete_rental">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check2-all me-1"></i>{% trans "Complete Rental" %}
                    </button>
                </form>
                {% endif %}

                {% if booking.status != 'completed' and booking.status != 'cancelled' %}
                <form method="post" action="{% url 'portal:booking_detail' booking.pk %}" onsubmit="return confirm('{% trans "Are you sure you want to cancel this booking?" %}');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="cancel_booking">
                    <button type="submit" class="btn btn-outline-danger w-100">
                        <i class="bi bi-x-circle me-1"></i>{% trans "Cancel Booking" %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Status Timeline -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history me-2"></i>{% trans "Status Timeline" %}
            </div>
            <div class="card-body">
                {% if status_history %}
                <div class="timeline">
                    {% for entry in status_history %}
                    <div class="d-flex gap-3 mb-3">
                        <div>
                            {% if entry.status == 'pending' %}
                                <span class="badge bg-warning rounded-circle p-2"><i class="bi bi-hourglass"></i></span>
                            {% elif entry.status == 'confirmed' %}
                                <span class="badge bg-info rounded-circle p-2"><i class="bi bi-check"></i></span>
                            {% elif entry.status == 'active' %}
                                <span class="badge bg-primary rounded-circle p-2"><i class="bi bi-play"></i></span>
                            {% elif entry.status == 'completed' %}
                                <span class="badge bg-success rounded-circle p-2"><i class="bi bi-check2-all"></i></span>
                            {% elif entry.status == 'cancelled' %}
                                <span class="badge bg-danger rounded-circle p-2"><i class="bi bi-x"></i></span>
                            {% endif %}
                        </div>
                        <div>
                            <div class="fw-semibold">{{ entry.get_status_display|default:entry.status }}</div>
                            <div class="text-muted small">{{ entry.created_at|date:"M d, Y H:i" }}</div>
                            {% if entry.notes %}
                            <div class="text-muted small">{{ entry.notes }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="d-flex gap-3 mb-3">
                    <div>
                        <span class="badge bg-secondary rounded-circle p-2"><i class="bi bi-plus"></i></span>
                    </div>
                    <div>
                        <div class="fw-semibold">{% trans "Created" %}</div>
                        <div class="text-muted small">{{ booking.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
