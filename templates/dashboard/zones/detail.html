{% extends 'dashboard/base.html' %}
{% load i18n %}

{% block title %}{{ zone.name }}{% endblock %}
{% block page_title %}{{ zone.name }}{% endblock %}

{% block extra_css %}
<style>
    #zone-map {
        height: 400px;
        border-radius: 0.5rem;
    }
    .radius-value {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--bs-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Zone Settings -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "Zone Settings" %}</h5>
                <span class="rounded-circle d-inline-block" style="width: 20px; height: 20px; background-color: {{ zone.color }};"></span>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_zone">

                    <div class="mb-3">
                        <label for="name" class="form-label">{% trans "Zone Name" %}</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ zone.name }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="description" name="description" rows="2">{{ zone.description }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="color" class="form-label">{% trans "Color" %}</label>
                        <input type="color" class="form-control form-control-color" id="color" name="color" value="{{ zone.color }}">
                    </div>

                    <div class="mb-3">
                        <label for="deposit_percentage" class="form-label">{% trans "Deposit Percentage" %}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="deposit_percentage" name="deposit_percentage"
                                   value="{{ zone.deposit_percentage }}" min="0" max="100" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">{% trans "Percentage of booking total required as deposit" %}</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if zone.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">{% trans "Active" %}</label>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">{% trans "Customer Information" %}</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">{% trans "Client Notice" %}</label>
                                <textarea name="client_notice" class="form-control" rows="2">{{ zone.client_notice }}</textarea>
                                <small class="text-muted">{% trans "Notice shown to customers for this zone" %}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{% trans "Notice Type" %}</label>
                                <select name="client_notice_type" class="form-select">
                                    <option value="info" {% if zone.client_notice_type == 'info' %}selected{% endif %}>{% trans "Info" %}</option>
                                    <option value="warning" {% if zone.client_notice_type == 'warning' %}selected{% endif %}>{% trans "Warning" %}</option>
                                    <option value="success" {% if zone.client_notice_type == 'success' %}selected{% endif %}>{% trans "Success" %}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{% trans "Pickup Instructions" %}</label>
                                <textarea name="pickup_instructions" class="form-control" rows="2">{{ zone.pickup_instructions }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{% trans "Area Description" %}</label>
                                <textarea name="area_description" class="form-control" rows="2">{{ zone.area_description }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{% trans "Display Order" %}</label>
                                <input type="number" name="display_order" class="form-control" value="{{ zone.display_order }}" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-braces me-2"></i>Custom Information
                        </div>
                        <div class="card-body">
                            <div id="customInfoPairs"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addCustomInfoPair()">
                                <i class="bi bi-plus-lg me-1"></i>Add Field
                            </button>
                            <input type="hidden" name="custom_info" id="customInfoInput">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-check-lg"></i> {% trans "Save Changes" %}
                    </button>
                </form>
            </div>
            <div class="card-footer bg-transparent">
                <form method="post" onsubmit="return confirm('{% trans "Are you sure you want to delete this zone? All distance ranges will also be deleted." %}');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_zone">
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                        <i class="bi bi-trash"></i> {% trans "Delete Zone" %}
                    </button>
                </form>
            </div>
        </div>

        <a href="{% url 'dashboard:zone_list' %}" class="btn btn-outline-secondary mt-3">
            <i class="bi bi-arrow-left"></i> {% trans "Back to Zones" %}
        </a>
    </div>

    <!-- Map and Distance Ranges -->
    <div class="col-lg-8">
        <!-- Map Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-geo-alt"></i> {% trans "Zone Boundary" %}</h5>
                {% if zone.has_coordinates %}
                <span class="badge bg-success">{% trans "Location Set" %}</span>
                {% else %}
                <span class="badge bg-warning">{% trans "No Location" %}</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div id="zone-map"></div>

                <form method="post" id="location-form" class="mt-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_location">

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="center_latitude" class="form-label">{% trans "Center Latitude" %}</label>
                            <input type="number" step="0.0000001" class="form-control" id="center_latitude" name="center_latitude"
                                   value="{{ zone.center_latitude|default:'' }}" placeholder="31.7917">
                        </div>
                        <div class="col-md-6">
                            <label for="center_longitude" class="form-label">{% trans "Center Longitude" %}</label>
                            <input type="number" step="0.0000001" class="form-control" id="center_longitude" name="center_longitude"
                                   value="{{ zone.center_longitude|default:'' }}" placeholder="-7.0926">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="radius_km" class="form-label">
                            {% trans "Zone Radius" %}: <span class="radius-value" id="radius-display">{{ zone.radius_km|default:"10" }}</span> km
                        </label>
                        <input type="range" class="form-range" id="radius_km" name="radius_km"
                               min="1" max="100" step="1" value="{{ zone.radius_km|default:'10' }}">
                        <div class="d-flex justify-content-between text-muted small">
                            <span>1 km</span>
                            <span>50 km</span>
                            <span>100 km</span>
                        </div>
                    </div>

                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle"></i> {% trans "Click on the map to set the center point, or enter coordinates manually. Adjust the radius slider to define the zone boundary." %}
                    </p>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-geo-alt"></i> {% trans "Save Location" %}
                    </button>
                </form>
            </div>
        </div>

        <!-- Distance Ranges -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "Distance Ranges" %}</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addRangeModal">
                    <i class="bi bi-plus-lg"></i> {% trans "Add Range" %}
                </button>
            </div>
            <div class="card-body">
                {% if distance_ranges %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Range Name" %}</th>
                                <th>{% trans "Min Distance" %}</th>
                                <th>{% trans "Max Distance" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th class="text-end">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for range in distance_ranges %}
                            <tr>
                                <td><strong>{{ range.name }}</strong></td>
                                <td>{{ range.min_km }} km</td>
                                <td>{{ range.max_km }} km</td>
                                <td>
                                    {% if range.is_active %}
                                    <span class="badge bg-success">{% trans "Active" %}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editRangeModal{{ range.pk }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form method="post" class="d-inline" onsubmit="return confirm('{% trans "Delete this distance range?" %}');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_range">
                                        <input type="hidden" name="range_id" value="{{ range.pk }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-rulers display-1 text-muted"></i>
                    <h5 class="mt-3">{% trans "No Distance Ranges" %}</h5>
                    <p class="text-muted">{% trans "Add distance ranges to define pricing tiers for this zone." %}</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRangeModal">
                        <i class="bi bi-plus-lg"></i> {% trans "Add First Range" %}
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Visual Range Display -->
        {% if distance_ranges %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Range Visualization" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for range in distance_ranges %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="border rounded p-3 h-100" style="border-left: 4px solid {{ zone.color }} !important;">
                            <div class="h5 mb-1">{{ range.name }}</div>
                            <div class="text-muted">{{ range.min_km }} - {{ range.max_km }} km</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Range Modal -->
<div class="modal fade" id="addRangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_range">

                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Add Distance Range" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_range_name" class="form-label">{% trans "Range Name" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="add_range_name" name="range_name" required placeholder="{% trans 'e.g., Short distance, Medium distance' %}">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_min_km" class="form-label">{% trans "Min Distance (km)" %} <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" min="0" class="form-control" id="add_min_km" name="min_km" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_max_km" class="form-label">{% trans "Max Distance (km)" %} <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" min="0" class="form-control" id="add_max_km" name="max_km" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Add Range" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Range Modals -->
{% for range in distance_ranges %}
<div class="modal fade" id="editRangeModal{{ range.pk }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_range">
                <input type="hidden" name="range_id" value="{{ range.pk }}">

                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Edit Distance Range" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_range_name_{{ range.pk }}" class="form-label">{% trans "Range Name" %}</label>
                        <input type="text" class="form-control" id="edit_range_name_{{ range.pk }}" name="range_name" value="{{ range.name }}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_min_km_{{ range.pk }}" class="form-label">{% trans "Min Distance (km)" %}</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="edit_min_km_{{ range.pk }}" name="min_km" value="{{ range.min_km }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_max_km_{{ range.pk }}" class="form-label">{% trans "Max Distance (km)" %}</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="edit_max_km_{{ range.pk }}" name="max_km" value="{{ range.max_km }}" required>
                        </div>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="edit_is_active_{{ range.pk }}" name="is_active" {% if range.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="edit_is_active_{{ range.pk }}">{% trans "Active" %}</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
<script>
let map, marker, circle;

function initMap() {
    // Initialize variables
    const defaultLat = {{ zone.center_latitude|default:"31.7917" }};
    const defaultLng = {{ zone.center_longitude|default:"-7.0926" }};
    const hasCoordinates = {{ zone.has_coordinates|yesno:"true,false" }};
    const zoneColor = '{{ zone.color }}';
    let currentRadiusKm = {{ zone.radius_km|default:"10" }};
    let currentRadiusM = currentRadiusKm * 1000;

    const center = { lat: defaultLat, lng: defaultLng };

    // Create map centered on Morocco
    map = new google.maps.Map(document.getElementById('zone-map'), {
        center: center,
        zoom: hasCoordinates ? 10 : 6,
        mapTypeControl: true,
        streetViewControl: false
    });

    // Create marker (draggable)
    marker = new google.maps.Marker({
        position: center,
        map: hasCoordinates ? map : null,
        draggable: true,
        title: '{{ zone.name }}'
    });

    // Create circle for zone boundary
    circle = new google.maps.Circle({
        map: hasCoordinates ? map : null,
        center: center,
        radius: currentRadiusM,
        strokeColor: zoneColor,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: zoneColor,
        fillOpacity: 0.2
    });

    // Fit bounds to circle if coordinates exist
    if (hasCoordinates) {
        map.fitBounds(circle.getBounds());
    }

    // Update form fields function
    function updateFormFields(lat, lng) {
        document.getElementById('center_latitude').value = lat.toFixed(7);
        document.getElementById('center_longitude').value = lng.toFixed(7);
    }

    // Update circle radius function
    function updateCircleRadius(radiusKm) {
        currentRadiusKm = radiusKm;
        currentRadiusM = radiusKm * 1000;
        circle.setRadius(currentRadiusM);
    }

    // Click on map to set center
    map.addListener('click', function(e) {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();

        // Update marker position
        marker.setPosition(e.latLng);
        if (!marker.getMap()) {
            marker.setMap(map);
        }

        // Update circle position
        circle.setCenter(e.latLng);
        if (!circle.getMap()) {
            circle.setMap(map);
        }

        updateFormFields(lat, lng);

        // Fit bounds to circle
        map.fitBounds(circle.getBounds());
    });

    // Drag marker to update position
    marker.addListener('dragend', function(e) {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();

        circle.setCenter(e.latLng);
        updateFormFields(lat, lng);
    });

    // Radius slider
    const radiusSlider = document.getElementById('radius_km');
    const radiusDisplay = document.getElementById('radius-display');

    radiusSlider.addEventListener('input', function() {
        const radiusKm = parseFloat(this.value);
        radiusDisplay.textContent = radiusKm;
        updateCircleRadius(radiusKm);

        // Fit bounds to circle if visible
        if (circle.getMap()) {
            map.fitBounds(circle.getBounds());
        }
    });

    // Manual coordinate input
    const latInput = document.getElementById('center_latitude');
    const lngInput = document.getElementById('center_longitude');

    function updateFromInputs() {
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);

        if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
            const newLatLng = new google.maps.LatLng(lat, lng);

            marker.setPosition(newLatLng);
            if (!marker.getMap()) {
                marker.setMap(map);
            }

            circle.setCenter(newLatLng);
            if (!circle.getMap()) {
                circle.setMap(map);
            }

            map.setCenter(newLatLng);
            map.fitBounds(circle.getBounds());
        }
    }

    latInput.addEventListener('change', updateFromInputs);
    lngInput.addEventListener('change', updateFromInputs);
}
</script>
<script>
const customInfoData = JSON.parse('{{ zone.custom_info|escapejs }}' || '{}');
const pairsContainer = document.getElementById('customInfoPairs');

function addCustomInfoPair(key='', value='') {
    const row = document.createElement('div');
    row.className = 'input-group mb-2';
    row.innerHTML = `<input type="text" class="form-control" placeholder="Key" value="${key}">
        <input type="text" class="form-control" placeholder="Value" value="${value}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove(); serializeCustomInfo();">&times;</button>`;
    row.querySelectorAll('input').forEach(i => i.addEventListener('input', serializeCustomInfo));
    pairsContainer.appendChild(row);
    serializeCustomInfo();
}

function serializeCustomInfo() {
    const pairs = {};
    pairsContainer.querySelectorAll('.input-group').forEach(row => {
        const inputs = row.querySelectorAll('input[type=text]');
        const k = inputs[0].value.trim();
        const v = inputs[1].value.trim();
        if (k) pairs[k] = v;
    });
    document.getElementById('customInfoInput').value = JSON.stringify(pairs);
}

// Init existing data
Object.entries(customInfoData).forEach(([k, v]) => addCustomInfoPair(k, v));
if (Object.keys(customInfoData).length === 0) serializeCustomInfo();
</script>
{% endblock %}
