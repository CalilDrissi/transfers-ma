{% extends "dashboard/base.html" %}
{% load static i18n %}

{% block title %}{% trans "Booking Form" %}{% endblock %}
{% block page_title %}{% trans "Booking Form" %}{% endblock %}

{% block extra_css %}
<style>
/* Booking Widget CSS (from WP plugin tb-booking.css) */
.tb-booking-widget {
    --tb-primary: #1a1a2e;
    --tb-accent: #e94560;
    --tb-accent-hover: #d63d56;
    --tb-light-bg: #f8f9fa;
    --tb-text-dark: #1a1a2e;
    --tb-text-muted: #6c757d;
    --tb-border: #e0e0e0;
    --tb-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    --tb-shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
    --tb-success: #10b981;
    --tb-error: #dc3545;
    --tb-radius: 12px;
    --tb-radius-sm: 8px;
    --tb-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.tb-booking-widget { font-family: var(--tb-font); color: var(--tb-text-dark); line-height: 1.5; max-width: 1100px; margin: 0 auto; padding: 0 1rem; }
.tb-booking-widget *, .tb-booking-widget *::before, .tb-booking-widget *::after { box-sizing: border-box; }
.tb-step { display: none; }
.tb-step--active { display: block; }
.tb-progress { display: flex; align-items: center; justify-content: center; gap: 0; padding: 1.5rem 0; margin-bottom: 1.5rem; }
.tb-progress__step { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; color: var(--tb-text-muted); font-size: 0.9rem; font-weight: 500; }
.tb-progress__step--active { color: var(--tb-accent); font-weight: 600; }
.tb-progress__step--completed { color: var(--tb-success); }
.tb-progress__number { width: 30px; height: 30px; border-radius: 50%; background: var(--tb-border); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; flex-shrink: 0; }
.tb-progress__step--active .tb-progress__number { background: var(--tb-accent); color: #fff; }
.tb-progress__step--completed .tb-progress__number { background: var(--tb-success); color: #fff; }
.tb-progress__connector { width: 40px; height: 2px; background: var(--tb-border); }
.tb-progress__label { display: none; }
@media (min-width: 576px) { .tb-progress__label { display: inline; } }
.tb-card { background: #fff; border-radius: var(--tb-radius); padding: 2rem; box-shadow: var(--tb-shadow); margin-bottom: 1.5rem; }
.tb-card__title { font-size: 1.25rem; font-weight: 700; margin: 0 0 1.5rem; }
.tb-form-group { margin-bottom: 1.25rem; }
.tb-form-row { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.25rem; }
@media (min-width: 576px) { .tb-form-row { grid-template-columns: 1fr 1fr; } .tb-form-group--half { margin-bottom: 0; } }
.tb-label { display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--tb-text-muted); margin-bottom: 0.5rem; }
.tb-input { width: 100%; padding: 12px 14px; border: 2px solid var(--tb-border); border-radius: var(--tb-radius-sm); font-size: 1rem; font-family: var(--tb-font); color: var(--tb-text-dark); background: #fff; transition: border-color 0.2s; }
.tb-input:focus { outline: none; border-color: var(--tb-accent); box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1); }
.tb-input--error { border-color: var(--tb-error); }
.tb-select { width: 100%; padding: 12px 14px; border: 2px solid var(--tb-border); border-radius: var(--tb-radius-sm); font-size: 1rem; font-family: var(--tb-font); color: var(--tb-text-dark); background: #fff; cursor: pointer; appearance: auto; }
.tb-select:focus { outline: none; border-color: var(--tb-accent); }
.tb-input-wrapper { position: relative; }
.tb-input-wrapper .tb-input { padding-left: 38px; }
.tb-input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--tb-accent); font-size: 0.75rem; z-index: 1; pointer-events: none; }
.tb-counter { display: flex; align-items: center; border: 2px solid var(--tb-border); border-radius: var(--tb-radius-sm); overflow: hidden; }
.tb-counter__btn { width: 44px; height: 44px; border: none; background: var(--tb-light-bg); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; color: var(--tb-text-dark); }
.tb-counter__btn:hover { background: var(--tb-border); }
.tb-counter__value { flex: 1; text-align: center; border: none; font-size: 1rem; font-weight: 600; font-family: var(--tb-font); background: #fff; -moz-appearance: textfield; color: var(--tb-text-dark); }
.tb-counter__value::-webkit-inner-spin-button, .tb-counter__value::-webkit-outer-spin-button { -webkit-appearance: none; }
.tb-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500; }
.tb-checkbox-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--tb-accent); }
.tb-field-error { color: var(--tb-error); font-size: 0.85rem; margin-top: 0.25rem; min-height: 0; }
.tb-alert { padding: 12px 16px; border-radius: var(--tb-radius-sm); margin-bottom: 1rem; font-size: 0.95rem; }
.tb-alert--error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.tb-btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 14px 28px; border: none; border-radius: var(--tb-radius-sm); font-size: 1rem; font-weight: 600; font-family: var(--tb-font); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.tb-btn--primary { background: var(--tb-accent); color: #fff; }
.tb-btn--primary:hover:not(:disabled) { background: var(--tb-accent-hover); }
.tb-btn--primary:disabled { opacity: 0.5; cursor: not-allowed; }
.tb-btn--full { width: 100%; }
.tb-btn--loading { pointer-events: none; opacity: 0.7; }
.tb-btn-back { display: inline-flex; align-items: center; gap: 0.25rem; background: none; border: none; color: var(--tb-text-muted); font-size: 0.95rem; font-weight: 500; font-family: var(--tb-font); cursor: pointer; padding: 0.5rem 0; margin-bottom: 1rem; }
.tb-btn-back:hover { color: var(--tb-accent); }
.tb-form-actions { margin-top: 1.5rem; }
.tb-autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border-radius: var(--tb-radius); box-shadow: var(--tb-shadow-lg); margin-top: 4px; z-index: 100; max-height: 280px; overflow-y: auto; display: none; }
.tb-autocomplete-dropdown.tb-show { display: block; }
.tb-autocomplete-item { padding: 14px 16px; cursor: pointer; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid var(--tb-border); font-size: 1rem; }
.tb-autocomplete-item:last-child { border-bottom: none; }
.tb-autocomplete-item:hover { background: var(--tb-light-bg); }
.tb-autocomplete-item__icon { color: var(--tb-text-muted); flex-shrink: 0; font-size: 1.25rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--tb-light-bg); border-radius: 50%; }
.tb-autocomplete-item__name { font-weight: 600; font-size: 1rem; }
.tb-autocomplete-item__type { font-size: 0.85rem; color: var(--tb-text-muted); }
.tb-step2-layout, .tb-step3-layout { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
@media (min-width: 768px) { .tb-step2-layout, .tb-step3-layout { grid-template-columns: 1fr 340px; } }
.tb-route-summary { background: #fff; border-radius: var(--tb-radius); padding: 1.25rem; box-shadow: var(--tb-shadow); margin-bottom: 1.5rem; }
.tb-route-points { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
.tb-route-point { display: flex; align-items: center; gap: 0.4rem; font-weight: 500; }
.tb-route-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.tb-route-dot--pickup { background: var(--tb-accent); }
.tb-route-dot--dropoff { background: var(--tb-primary); }
.tb-route-arrow { color: var(--tb-text-muted); }
.tb-route-meta { display: flex; gap: 1.5rem; margin-top: 0.5rem; color: var(--tb-text-muted); font-size: 0.9rem; }
.tb-section-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem; }
.tb-section-subtitle { color: var(--tb-text-muted); font-size: 0.9rem; margin: -0.5rem 0 1rem; }
.tb-vehicles-container { display: flex; flex-direction: column; gap: 0; }
/* ── Vehicle Cards — SinaiTaxi Style ── */
.tb-vehicle-card { background: #fff; border-bottom: 1px solid #eee; padding: 20px 0; cursor: pointer; transition: background 0.15s; border: 2px solid transparent; border-radius: 0; box-shadow: none; display: block; }
.tb-vehicle-card:hover { background: #fafbfc; }
.tb-vehicle-card.tb-selected { border: 2px solid var(--tb-accent); border-radius: var(--tb-radius); background: rgba(233, 69, 96, 0.02); }
.tb-vehicle-card__header { font-size: 1.15rem; font-weight: 700; color: var(--tb-text-dark); margin: 0 0 12px; padding: 0 4px; }
.tb-vehicle-card__body { display: flex; align-items: center; gap: 20px; }
.tb-vehicle-card__image { width: 180px; height: 110px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.tb-vehicle-card__image img { max-width: 100%; max-height: 100%; object-fit: contain; }
.tb-vehicle-card__image-placeholder { font-size: 3rem; color: var(--tb-text-muted); opacity: 0.4; }
.tb-vehicle-card__details { flex: 1; min-width: 0; }
.tb-vehicle-card__specs { display: flex; gap: 16px; margin-bottom: 10px; font-size: 0.9rem; color: var(--tb-text-dark); font-weight: 500; }
.tb-vehicle-card__spec { display: flex; align-items: center; gap: 5px; }
.tb-vehicle-card__spec svg { width: 16px; height: 16px; color: var(--tb-text-muted); }
.tb-vehicle-card__features { display: flex; flex-direction: column; gap: 5px; margin-bottom: 8px; }
.tb-vehicle-card__feature { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #555; }
.tb-vehicle-card__feature svg { width: 16px; height: 16px; flex-shrink: 0; }
.tb-vehicle-card__feature--ok svg { color: var(--tb-success); }
.tb-vehicle-card__feature--time svg { color: var(--tb-text-muted); }
.tb-vehicle-card__models { font-size: 0.78rem; color: #999; font-style: italic; margin: 0; }
.tb-vehicle-card__pricing { text-align: right; flex-shrink: 0; min-width: 110px; display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.tb-vehicle-card__price-amount { font-size: 1.4rem; font-weight: 700; color: var(--tb-text-dark); }
.tb-vehicle-card__price-currency { font-size: 0.85rem; font-weight: 500; color: var(--tb-text-muted); margin-left: 2px; }
.tb-vehicle-card__payment-icons { display: flex; gap: 4px; align-items: center; }
.tb-vehicle-card__payment-icon { width: 32px; height: 20px; border-radius: 3px; background: var(--tb-light-bg); display: flex; align-items: center; justify-content: center; border: 1px solid #e0e0e0; }
.tb-vehicle-card__payment-icon svg { width: 20px; height: 14px; }
.tb-vehicle-card__select-btn { background: var(--tb-accent); color: #fff; border: none; border-radius: 6px; padding: 9px 28px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: filter 0.2s; font-family: var(--tb-font); }
.tb-vehicle-card__select-btn:hover { filter: brightness(0.9); }
.tb-extras-section { margin-top: 2rem; }
.tb-extra-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid var(--tb-border); border-radius: var(--tb-radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; gap: 1rem; }
.tb-extra-item:hover { border-color: var(--tb-accent); }
.tb-extra-item.tb-selected { border-color: var(--tb-accent); background: rgba(233, 69, 96, 0.02); }
.tb-extra-info { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
.tb-extra-check { width: 20px; height: 20px; border: 2px solid var(--tb-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; font-size: 0.75rem; color: transparent; }
.tb-extra-item.tb-selected .tb-extra-check { background: var(--tb-accent); border-color: var(--tb-accent); color: #fff; }
.tb-extra-name { font-weight: 500; }
.tb-extra-desc { font-size: 0.8rem; color: var(--tb-text-muted); }
.tb-extra-right { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
.tb-extra-qty { display: flex; align-items: center; gap: 0.5rem; }
.tb-extra-qty button { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--tb-border); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.2s; }
.tb-extra-qty button:hover { border-color: var(--tb-accent); color: var(--tb-accent); }
.tb-extra-price { font-weight: 600; color: var(--tb-accent); white-space: nowrap; }
.tb-sidebar { background: #fff; border-radius: var(--tb-radius); padding: 1.5rem; box-shadow: var(--tb-shadow); position: sticky; top: 100px; }
.tb-sidebar__title { font-weight: 700; margin: 0 0 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--tb-border); }
.tb-summary-item { display: flex; justify-content: space-between; padding: 0.4rem 0; font-size: 0.9rem; }
.tb-summary-label { color: var(--tb-text-muted); }
.tb-summary-value { font-weight: 500; text-align: right; max-width: 60%; word-break: break-word; }
.tb-summary-total { font-weight: 700; font-size: 1.1rem; padding-top: 1rem; margin-top: 0.75rem; border-top: 1px solid var(--tb-border); }
.tb-sidebar .tb-btn { margin-top: 1.25rem; }
.tb-loading { text-align: center; padding: 3rem 1rem; color: var(--tb-text-muted); }
.tb-spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid var(--tb-border); border-top-color: var(--tb-accent); border-radius: 50%; animation: tb-spin 0.6s linear infinite; vertical-align: middle; margin-right: 0.5rem; }
@keyframes tb-spin { to { transform: rotate(360deg); } }
.tb-confirmation { text-align: center; padding: 3rem 1rem; max-width: 500px; margin: 0 auto; }
.tb-confirmation__icon { width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: var(--tb-success); }
.tb-confirmation__title { font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem; }
.tb-confirmation__subtitle { color: var(--tb-text-muted); margin: 0 0 1.5rem; }
.tb-confirmation__ref { display: inline-block; font-size: 1.4rem; font-weight: 700; color: var(--tb-accent); background: rgba(233, 69, 96, 0.1); padding: 0.75rem 1.5rem; border-radius: var(--tb-radius-sm); margin-bottom: 1.5rem; }
.tb-confirmation__email { color: var(--tb-text-muted); margin-bottom: 2rem; }
#tb-stripe-element { padding: 1rem 0; }
.pac-container { z-index: 100000 !important; font-family: var(--tb-font); border-radius: var(--tb-radius) !important; border: none !important; box-shadow: var(--tb-shadow-lg) !important; margin-top: 4px !important; }
.pac-item { padding: 10px 14px !important; cursor: pointer !important; border-bottom: 1px solid var(--tb-border) !important; }
.pac-item:hover { background: var(--tb-light-bg) !important; }
.tb-no-route { text-align: center; padding: 3rem 1.5rem; background: #fff; border-radius: var(--tb-radius); box-shadow: var(--tb-shadow); }
.tb-no-route__icon { color: var(--tb-accent); margin-bottom: 1.25rem; }
.tb-no-route__message { font-size: 1.1rem; color: var(--tb-text-dark); line-height: 1.6; max-width: 480px; margin: 0 auto 1.5rem; }
.tb-no-route__contacts { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; }
.tb-no-route__contact-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 10px 20px; border-radius: var(--tb-radius-sm); font-size: 0.95rem; font-weight: 600; text-decoration: none; transition: all 0.2s; border: 2px solid var(--tb-border); color: var(--tb-text-dark); }
.tb-no-route__contact-btn:hover { border-color: var(--tb-accent); color: var(--tb-accent); }
.tb-no-route__contact-btn--whatsapp { background: #25D366; border-color: #25D366; color: #fff; }
.tb-no-route__contact-btn--whatsapp:hover { background: #1da851; border-color: #1da851; color: #fff; }
@media (max-width: 768px) {
    .tb-vehicle-card__body { flex-direction: column; align-items: stretch; }
    .tb-vehicle-card__image { width: 100%; height: 130px; }
    .tb-vehicle-card__pricing { flex-direction: row; align-items: center; justify-content: space-between; min-width: unset; border-top: 1px solid #eee; padding-top: 12px; margin-top: 4px; }
    .tb-sidebar { position: static; }
}

/* ── Step 1: Dark hero background ── */
#tb-step-1 { background: linear-gradient(135deg, #0a1628, #162544); border-radius: 16px; padding: 2rem 1.5rem; position: relative; }

/* ── Mode tabs ── */
.tb-mode-tabs { display: flex; justify-content: center; gap: 4px; margin-bottom: 1.5rem; }
.tb-mode-tab { background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 0.9rem; font-weight: 600; font-family: var(--tb-font); padding: 8px 20px; border-radius: 30px; cursor: pointer; transition: all 0.2s; }
.tb-mode-tab:hover { color: rgba(255,255,255,0.9); }
.tb-mode-tab--active { background: #fff; color: var(--tb-text-dark); }

/* ── Pill bar (shared) ── */
.tb-pill-bar__row { display: flex; align-items: stretch; gap: 8px; }
.tb-pill-bar__field { flex: 1 1 0; min-width: 0; position: relative; display: flex; flex-direction: row; align-items: center; gap: 10px; padding: 12px 16px; background: #fff; border-radius: 50px; border: 2px solid transparent; transition: border-color 0.2s, box-shadow 0.2s; }
.tb-pill-bar__field:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
.tb-pill-bar__field--from { position: relative; }
.tb-pill-bar__icon { flex-shrink: 0; font-size: 1rem; color: var(--tb-text-dark); line-height: 1; }
.tb-pill-bar__input { border: none; background: transparent; font-size: 1rem; font-family: var(--tb-font); color: var(--tb-text-dark); padding: 0; width: 100%; outline: none; min-width: 0; }
.tb-pill-bar__input::placeholder { color: #9ca3af; }
.tb-pill-bar__input:focus { outline: none; }
.tb-pill-bar__clear { flex-shrink: 0; width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; border: none; cursor: pointer; font-size: 1rem; line-height: 1; display: flex; align-items: center; justify-content: center; color: #6b7280; transition: all 0.15s; }
.tb-pill-bar__clear:hover { background: #d1d5db; color: #374151; }
.tb-pill-bar__label { display: none; }
.tb-pill-bar__divider { display: none; }

/* Autocomplete dropdown inside pill bar */
.tb-pill-bar__field .tb-autocomplete-dropdown { position: absolute; top: calc(100% + 6px); left: 0; right: 0; z-index: 100; min-width: 300px; }

/* ── Swap button ── */
.tb-pill-bar__swap { position: absolute; right: -18px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; font-size: 0.85rem; color: var(--tb-text-muted); transition: all 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
.tb-pill-bar__swap:hover { border-color: var(--tb-accent); color: var(--tb-accent); background: #fff; }

/* ── Return field ── */
#tb-return-field { position: relative; }

/* ── Add return button ── */
.tb-pill-bar__add-return { border: none; background: transparent; color: var(--tb-accent); font-size: 0.85rem; font-weight: 600; cursor: pointer; padding: 8px 12px; white-space: nowrap; font-family: var(--tb-font); flex-shrink: 0; }
.tb-pill-bar__add-return:hover { text-decoration: underline; }

/* ── Pax pill ── */
.tb-pill-bar__pax { position: relative; display: flex; align-items: center; padding: 0 8px; }
.tb-pax-pill { display: flex; align-items: center; gap: 6px; background: var(--tb-light-bg); border: 1px solid var(--tb-border); border-radius: 30px; padding: 8px 14px; cursor: pointer; white-space: nowrap; font-size: 0.85rem; font-weight: 500; color: var(--tb-text-dark); transition: border-color 0.2s; font-family: var(--tb-font); }
.tb-pax-pill:hover { border-color: var(--tb-accent); }
.tb-pax-pill__icon { font-size: 1rem; }

/* ── Pax dropdown ── */
.tb-pax-dropdown { position: absolute; top: auto; right: 0; background: #fff; border-radius: var(--tb-radius); box-shadow: var(--tb-shadow-lg); padding: 16px; z-index: 200; min-width: 220px; display: none; }
.tb-pax-dropdown.tb-show { display: block; }
.tb-pax-stepper { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
.tb-pax-stepper + .tb-pax-stepper { border-top: 1px solid var(--tb-border); }
.tb-pax-stepper__label { font-size: 0.9rem; font-weight: 500; }
.tb-pax-stepper__controls { display: flex; align-items: center; gap: 12px; }
.tb-pax-stepper__btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--tb-border); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.2s; color: var(--tb-text-dark); font-family: var(--tb-font); }
.tb-pax-stepper__btn:hover { border-color: var(--tb-accent); color: var(--tb-accent); }
.tb-pax-stepper__value { font-weight: 600; min-width: 20px; text-align: center; font-size: 1rem; }

/* ── Search button ── */
.tb-pill-bar__search { border-radius: 40px; padding: 12px 28px; background: var(--tb-accent); color: #fff; border: none; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: background 0.2s; white-space: nowrap; font-family: var(--tb-font); flex-shrink: 0; align-self: center; }
.tb-pill-bar__search:hover { background: var(--tb-accent-hover); }
.tb-pill-bar__search:disabled { opacity: 0.5; cursor: not-allowed; }

/* ── Multi-city bar ── */
.tb-multi-bar { display: none; }
.tb-leg-row { display: flex; align-items: center; gap: 12px; background: #fff; border-radius: 16px; padding: 8px 12px 8px 16px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.tb-leg-row__number { width: 28px; height: 28px; border-radius: 50%; background: var(--tb-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; }
.tb-leg-row__fields { display: flex; flex: 1; align-items: stretch; gap: 8px; min-width: 0; }
.tb-leg-row__fields .tb-pill-bar__field { background: var(--tb-light-bg); border-radius: 30px; padding: 8px 14px; }
.tb-leg-row__remove { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--tb-border); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--tb-text-muted); flex-shrink: 0; transition: all 0.2s; }
.tb-leg-row__remove:hover { border-color: var(--tb-error); color: var(--tb-error); background: #fee2e2; }

/* Add leg button */
#tb-add-leg { display: flex; align-items: center; gap: 8px; background: transparent; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; padding: 10px 16px; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 0.9rem; font-weight: 600; font-family: var(--tb-font); margin-bottom: 12px; transition: all 0.2s; width: 100%; justify-content: center; }
#tb-add-leg:hover { border-color: rgba(255,255,255,0.6); color: #fff; }

/* Multi-city footer */
.tb-multi-bar__footer { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }

/* ── Flight bar ── */
#tb-flight-bar { display: none; margin-top: 12px; }
#tb-flight-bar .tb-pill-bar__input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 10px 14px; color: #fff; }
#tb-flight-bar .tb-pill-bar__input::placeholder { color: rgba(255,255,255,0.4); }
#tb-flight-bar .tb-pill-bar__label { color: rgba(255,255,255,0.6); margin-bottom: 4px; }

/* ── No route container ── */
#tb-no-route-container { margin-top: 1rem; }

/* ── Multi-city progress indicator ── */
#tb-multi-progress { text-align: center; color: var(--tb-accent); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; display: none; }

/* ── Validation ── */
.tb-pill-bar__field--invalid { background: rgba(220, 53, 69, 0.08) !important; }
.tb-pill-bar__field--invalid .tb-pill-bar__input { color: var(--tb-error); }
@keyframes tb-shake { 0%, 100% { transform: translateX(0); } 15%, 45%, 75% { transform: translateX(-6px); } 30%, 60%, 90% { transform: translateX(6px); } }
.tb-shake { animation: tb-shake 0.5s ease-in-out; }

/* ── Mobile responsive ── */
@media (max-width: 768px) {
    #tb-step-1 { padding: 1.25rem 1rem; border-radius: 12px; }
    .tb-pill-bar__row { flex-direction: column; gap: 8px; }
    .tb-pill-bar__field { width: 100%; border-radius: 16px; padding: 12px 14px; }
    .tb-pill-bar__swap { position: static; transform: none; width: 100%; height: 36px; border-radius: 8px; margin: -2px 0; box-shadow: none; }
    .tb-pill-bar__search { width: 100%; border-radius: 16px; padding: 14px; }
    .tb-pill-bar__pax { width: 100%; padding: 0; }
    .tb-pax-pill { width: 100%; justify-content: center; }
    .tb-pill-bar__add-return { width: 100%; text-align: center; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); border-radius: 16px; padding: 12px; color: rgba(255,255,255,0.7); }
    #tb-return-field { width: 100%; }

    /* Pax dropdown as bottom sheet on mobile */
    .tb-pax-dropdown { position: fixed; bottom: 0; left: 0; right: 0; top: auto; border-radius: 16px 16px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); min-width: unset; padding: 20px; z-index: 1000; }

    /* Multi-city leg rows */
    .tb-leg-row { flex-direction: column; align-items: stretch; padding: 12px; }
    .tb-leg-row__number { align-self: flex-start; }
    .tb-leg-row__fields { flex-direction: column; }
    .tb-leg-row__fields .tb-pill-bar__field { width: 100%; }
    .tb-leg-row__remove { align-self: flex-end; margin-top: -20px; }
    .tb-multi-bar__footer { flex-direction: column; }
    .tb-multi-bar__footer .tb-pax-pill { width: 100%; justify-content: center; }
    .tb-multi-bar__footer .tb-pill-bar__search { width: 100%; }
}

/* ── Return-to-start toggle ── */
.tb-return-toggle { display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.8); font-size: 0.9rem; font-weight: 500; cursor: pointer; padding: 4px 0; margin-bottom: 8px; }
.tb-return-toggle input { accent-color: var(--tb-accent); width: 18px; height: 18px; }
.tb-leg-row--return .tb-leg-row__number { background: var(--tb-text-muted); font-size: 0.7rem; }
.tb-leg-row--return .tb-pill-bar__input[readonly] { opacity: 0.6; cursor: default; }

/* ── Gateway options ── */
.tb-gateways-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 1rem; }
.tb-gateway-option { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid var(--tb-border); border-radius: var(--tb-radius-sm); cursor: pointer; transition: all 0.2s; }
.tb-gateway-option:hover { border-color: var(--tb-accent); }
.tb-gateway-option--selected { border-color: var(--tb-accent); background: rgba(233, 69, 96, 0.02); }
.tb-gateway-option__radio { width: 20px; height: 20px; border: 2px solid var(--tb-border); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
.tb-gateway-option--selected .tb-gateway-option__radio { border-color: var(--tb-accent); }
.tb-gateway-option--selected .tb-gateway-option__radio::after { content: ''; width: 10px; height: 10px; border-radius: 50%; background: var(--tb-accent); }
.tb-gateway-option__info { flex: 1; }
.tb-gateway-option__label { font-weight: 600; font-size: 0.95rem; }
.tb-gateway-option__desc { font-size: 0.8rem; color: var(--tb-text-muted); margin-top: 2px; }

/* ── Coupon input row ── */
.tb-coupon-input-row { display: flex; gap: 8px; }
.tb-coupon-input-row .tb-input { flex: 1; }

/* Prevent iOS zoom on input focus */
.tb-pill-bar__input, .tb-pax-pill, .tb-pill-bar__search, #tb-add-leg, .tb-mode-tab { font-size: 16px; }
@media (min-width: 769px) {
    .tb-pill-bar__input { font-size: 0.95rem; }
    .tb-pax-pill { font-size: 0.85rem; }
    .tb-pill-bar__search { font-size: 0.95rem; }
    #tb-add-leg { font-size: 0.9rem; }
    .tb-mode-tab { font-size: 0.9rem; }
}

/* ══ Step 3: SinaiTaxi Checkout ══ */

/* Progress bar */
.tb-checkout-progress { display: flex; margin-bottom: 2rem; border-radius: var(--tb-radius); overflow: hidden; }
.tb-checkout-progress__step { flex: 1; text-align: center; padding: 12px 16px; font-size: 0.85rem; font-weight: 600; font-family: var(--tb-font); color: #fff; background: #ccc; position: relative; }
.tb-checkout-progress__step--done { background: var(--tb-accent); opacity: 0.7; }
.tb-checkout-progress__step--active { background: var(--tb-accent); }
.tb-checkout-progress__step--upcoming { background: #ddd; color: #999; }

/* Location pins */
.tb-checkout-location { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; }
.tb-checkout-location__dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
.tb-checkout-location__dot--pickup { background: var(--tb-accent); }
.tb-checkout-location__dot--dropoff { background: var(--tb-primary); }
.tb-checkout-location__text { font-size: 0.95rem; font-weight: 500; color: var(--tb-text-dark); }

/* Two-column checkout rows */
.tb-checkout-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
@media (max-width: 576px) { .tb-checkout-row { grid-template-columns: 1fr; } }

/* Toggle switch (iOS style) */
.tb-toggle { position: relative; display: inline-block; width: 48px; height: 26px; flex-shrink: 0; }
.tb-toggle input { opacity: 0; width: 0; height: 0; }
.tb-toggle__slider { position: absolute; inset: 0; background: #ccc; border-radius: 26px; cursor: pointer; transition: 0.3s; }
.tb-toggle__slider::before { content: ''; position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #fff; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.tb-toggle input:checked + .tb-toggle__slider { background: var(--tb-accent); }
.tb-toggle input:checked + .tb-toggle__slider::before { transform: translateX(22px); }

/* Toggle row */
.tb-toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-top: 1px solid var(--tb-border); }
.tb-toggle-row__label { font-weight: 600; font-size: 0.95rem; }

/* Passenger counter (inline pill) */
.tb-counter-inline { display: inline-flex; align-items: center; border: 1px solid var(--tb-border); border-radius: 30px; overflow: hidden; }
.tb-counter-inline__btn { width: 36px; height: 36px; border: none; background: var(--tb-light-bg); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--tb-text-dark); font-family: var(--tb-font); transition: all 0.15s; }
.tb-counter-inline__btn:hover { background: var(--tb-border); }
.tb-counter-inline__btn--active { background: var(--tb-accent); color: #fff; }
.tb-counter-inline__btn--active:hover { filter: brightness(0.9); }
.tb-counter-inline__value { min-width: 40px; text-align: center; font-weight: 600; font-size: 1rem; background: #fff; }

/* Service row (extras as toggles) */
.tb-service-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--tb-border); }
.tb-service-row:last-child { border-bottom: none; }
.tb-service-row__info { flex: 1; }
.tb-service-row__name { font-weight: 600; font-size: 0.95rem; }
.tb-service-row__price { color: var(--tb-accent); font-weight: 600; font-size: 0.85rem; }
.tb-service-row__desc { font-size: 0.8rem; color: var(--tb-text-muted); }

/* Gradient summary sidebar */
.tb-summary-gradient { background: linear-gradient(135deg, var(--tb-accent), color-mix(in srgb, var(--tb-accent) 70%, #000)); border-radius: var(--tb-radius); padding: 24px; color: #fff; position: sticky; top: 100px; }
@supports not (color: color-mix(in srgb, red, blue)) { .tb-summary-gradient { background: linear-gradient(135deg, var(--tb-accent), #b8304f); } }
.tb-summary-gradient__header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.2); }
.tb-summary-gradient__icon { width: 40px; height: 40px; background: rgba(255,255,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
.tb-summary-gradient__vehicle-name { font-weight: 700; font-size: 1rem; }
.tb-summary-gradient__vehicle-cap { font-size: 0.8rem; opacity: 0.8; }
.tb-summary-gradient__stop { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 0.85rem; }
.tb-summary-gradient__dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.6); flex-shrink: 0; }
.tb-summary-gradient__stop-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tb-summary-gradient__stop-price { font-weight: 600; white-space: nowrap; }
.tb-summary-gradient__total { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px dashed rgba(255,255,255,0.3); font-weight: 700; font-size: 1rem; }
.tb-summary-gradient__extras { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; font-size: 0.85rem; }
.tb-summary-gradient__extra { display: flex; justify-content: space-between; opacity: 0.9; }
.tb-summary-gradient__deposit { display: flex; justify-content: space-between; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.15); font-size: 0.85rem; opacity: 0.9; }

/* Phone input with flag prefix */
.tb-phone-input { display: flex; align-items: center; border: 2px solid var(--tb-border); border-radius: var(--tb-radius-sm); overflow: hidden; transition: border-color 0.2s; }
.tb-phone-input:focus-within { border-color: var(--tb-accent); box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1); }
.tb-phone-input__prefix { display: flex; align-items: center; gap: 6px; padding: 0 10px; background: var(--tb-light-bg); border-right: 1px solid var(--tb-border); font-size: 0.9rem; color: var(--tb-text-muted); white-space: nowrap; height: 44px; }
.tb-phone-input__field { flex: 1; border: none; padding: 12px; font-size: 1rem; font-family: var(--tb-font); color: var(--tb-text-dark); background: #fff; outline: none; }
</style>
{% endblock %}

{% block content %}
<div class="mb-3">
    <small class="text-muted">
        <i class="bi bi-info-circle"></i>
        {% trans "This is the embedded booking form widget for testing. It connects directly to the API." %}
    </small>
</div>

<!-- Booking Widget -->
<div id="tb-booking-widget" class="tb-booking-widget" dir="ltr">

    <!-- Multi-city progress indicator -->
    <div id="tb-multi-progress"></div>

    <!-- Progress Bar -->
    <div class="tb-progress">
        <div class="tb-progress__step tb-progress__step--active" data-step="1">
            <span class="tb-progress__number">1</span>
            <span class="tb-progress__label">{% trans "Route" %}</span>
        </div>
        <div class="tb-progress__connector"></div>
        <div class="tb-progress__step" data-step="2">
            <span class="tb-progress__number">2</span>
            <span class="tb-progress__label">{% trans "Vehicle" %}</span>
        </div>
        <div class="tb-progress__connector"></div>
        <div class="tb-progress__step" data-step="3">
            <span class="tb-progress__number">3</span>
            <span class="tb-progress__label">{% trans "Payment" %}</span>
        </div>
    </div>

    <!-- Step 1: Route -->
    <div id="tb-step-1" class="tb-step tb-step--active">

        <!-- Mode tabs -->
        <div class="tb-mode-tabs">
            <button type="button" class="tb-mode-tab tb-mode-tab--active" data-mode="one-way">{% trans "One-way" %}</button>
            <button type="button" class="tb-mode-tab" data-mode="round-trip">{% trans "Round trip" %}</button>
            <button type="button" class="tb-mode-tab" data-mode="multi-city">{% trans "Multi-city" %}</button>
        </div>

        <!-- Single trip pill bar (one-way & round-trip) -->
        <div id="tb-single-bar">
            <div class="tb-pill-bar__row">
                <div class="tb-pill-bar__field tb-pill-bar__field--from">
                    <span class="tb-pill-bar__icon">&#9679;</span>
                    <input type="text" class="tb-pill-bar__input" data-leg="0" data-field="pickup" placeholder="{% trans 'From city, airport, or hotel...' %}" autocomplete="off">
                    <button type="button" class="tb-pill-bar__clear" aria-label="{% trans 'Clear' %}" style="display:none;">&times;</button>
                    <div class="tb-autocomplete-dropdown" data-leg="0" data-dropdown="pickup"></div>
                    <button type="button" class="tb-pill-bar__swap" id="tb-swap-btn" title="{% trans 'Swap locations' %}">&#8652;</button>
                </div>
                <div class="tb-pill-bar__field tb-pill-bar__field--to">
                    <span class="tb-pill-bar__icon">&#9906;</span>
                    <input type="text" class="tb-pill-bar__input" data-leg="0" data-field="dropoff" placeholder="{% trans 'To city, hotel, or address...' %}" autocomplete="off">
                    <button type="button" class="tb-pill-bar__clear" aria-label="{% trans 'Clear' %}" style="display:none;">&times;</button>
                    <div class="tb-autocomplete-dropdown" data-leg="0" data-dropdown="dropoff"></div>
                </div>
                <div class="tb-pill-bar__field tb-pill-bar__field--date">
                    <span class="tb-pill-bar__icon">&#128197;</span>
                    <input type="datetime-local" class="tb-pill-bar__input" data-leg="0" data-field="datetime">
                </div>
                <div class="tb-pill-bar__field tb-pill-bar__field--return" id="tb-return-field" style="display:none;">
                    <span class="tb-pill-bar__icon">&#128197;</span>
                    <input type="datetime-local" class="tb-pill-bar__input" id="tb-return-datetime" data-field="return-datetime">
                    <button type="button" class="tb-pill-bar__clear tb-pill-bar__return-remove" id="tb-remove-return" title="{% trans 'Remove return' %}">&times;</button>
                </div>
                <button type="button" class="tb-pill-bar__add-return" id="tb-add-return">+ {% trans "Return" %}</button>
                <div class="tb-pill-bar__pax">
                    <div class="tb-pax-pill" id="tb-pax-pill">
                        <span class="tb-pax-pill__icon">&#128100;</span>
                        <span id="tb-pax-pill-text">1 pax, 1 bag</span>
                        <span>&#9662;</span>
                    </div>
                </div>
                <button type="button" id="tb-btn-search" class="tb-pill-bar__search">{% trans "Search" %}</button>
            </div>
        </div>

        <!-- Multi-city bar -->
        <div id="tb-multi-bar" class="tb-multi-bar">
            <div id="tb-legs-container"></div>
            <label id="tb-return-to-start" class="tb-return-toggle" style="display:none;">
                <input type="checkbox" id="tb-return-to-start-check">
                ↩ {% trans "Return to start" %}
            </label>
            <button type="button" id="tb-add-leg">+ {% trans "Add another transfer" %}</button>
            <div class="tb-multi-bar__footer">
                <div class="tb-pill-bar__pax" style="position:relative;">
                    <div class="tb-pax-pill" id="tb-pax-pill-multi">
                        <span class="tb-pax-pill__icon">&#128100;</span>
                        <span id="tb-pax-pill-text-multi">1 pax, 1 bag</span>
                        <span>&#9662;</span>
                    </div>
                </div>
                <button type="button" id="tb-btn-search-multi" class="tb-pill-bar__search">{% trans "Search" %}</button>
            </div>
        </div>

        <!-- Flight number (shown below bar when airport detected) -->
        <div id="tb-flight-bar">
            <label class="tb-pill-bar__label">{% trans "Flight Number" %}</label>
            <input type="text" id="tb-flight-number" class="tb-pill-bar__input" placeholder="{% trans 'e.g. AT 1234' %}" autocomplete="off">
        </div>

        <!-- Error display -->
        <div id="tb-no-route-container" style="display:none;"></div>

        <!-- Pax/luggage dropdown (shared by single & multi-city) -->
        <div class="tb-pax-dropdown" id="tb-pax-dropdown">
            <div class="tb-pax-stepper">
                <span class="tb-pax-stepper__label">{% trans "Passengers" %}</span>
                <div class="tb-pax-stepper__controls">
                    <button type="button" class="tb-pax-stepper__btn" data-target="tb-pax-count" data-action="decrease">-</button>
                    <span class="tb-pax-stepper__value" id="tb-pax-count">1</span>
                    <button type="button" class="tb-pax-stepper__btn" data-target="tb-pax-count" data-action="increase">+</button>
                </div>
            </div>
            <div class="tb-pax-stepper">
                <span class="tb-pax-stepper__label">{% trans "Luggage" %}</span>
                <div class="tb-pax-stepper__controls">
                    <button type="button" class="tb-pax-stepper__btn" data-target="tb-luggage-count" data-action="decrease">-</button>
                    <span class="tb-pax-stepper__value" id="tb-luggage-count">1</span>
                    <button type="button" class="tb-pax-stepper__btn" data-target="tb-luggage-count" data-action="increase">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Vehicle -->
    <div id="tb-step-2" class="tb-step">
        <button type="button" class="tb-btn-back" data-back="1">
            &larr; {% trans "Back to search" %}
        </button>
        <div class="tb-route-summary">
            <div class="tb-route-points">
                <span class="tb-route-point">
                    <span class="tb-route-dot tb-route-dot--pickup"></span>
                    <span id="tb-result-pickup">--</span>
                </span>
                <span class="tb-route-arrow">&rarr;</span>
                <span class="tb-route-point">
                    <span class="tb-route-dot tb-route-dot--dropoff"></span>
                    <span id="tb-result-dropoff">--</span>
                </span>
            </div>
            <div class="tb-route-meta">
                <span id="tb-result-distance">--</span>
                <span id="tb-result-duration">--</span>
            </div>
        </div>
        <h4 class="tb-section-title">{% trans "Choose your vehicle" %}</h4>
        <div id="tb-vehicles-container" class="tb-vehicles-container">
            <div class="tb-loading">{% trans "Loading vehicles..." %}</div>
        </div>
        <div id="tb-extras-section" class="tb-extras-section" style="display: none;">
            <h4 class="tb-section-title">{% trans "Add extras" %}</h4>
            <p class="tb-section-subtitle">{% trans "Optional services to enhance your journey" %}</p>
            <div id="tb-extras-container"></div>
        </div>
        <button type="button" id="tb-btn-continue" class="tb-btn tb-btn--primary tb-btn--full" disabled>
            {% trans "Continue" %}
        </button>
        <!-- Hidden sidebar elements for JS compat -->
        <div style="display:none">
            <span id="tb-sidebar-route"></span>
            <span id="tb-sidebar-date"></span>
            <span id="tb-sidebar-vehicle"></span>
            <span id="tb-sidebar-passengers"></span>
            <div id="tb-sidebar-extras-list"></div>
            <span id="tb-sidebar-total"></span>
        </div>
    </div>

    <!-- Step 3: Payment -->
    <div id="tb-step-3" class="tb-step">
        <!-- Checkout Progress -->
        <div class="tb-checkout-progress">
            <div class="tb-checkout-progress__step tb-checkout-progress__step--done">{% trans "Ride Type" %}</div>
            <div class="tb-checkout-progress__step tb-checkout-progress__step--active">{% trans "Booking Details" %}</div>
            <div class="tb-checkout-progress__step tb-checkout-progress__step--upcoming">{% trans "Checkout" %}</div>
        </div>
        <div class="tb-step3-layout">
            <div class="tb-step3-main">
                <button type="button" class="tb-btn-back" data-back="2">&larr; {% trans "Back to vehicle" %}</button>
                <!-- Transfer Details Card -->
                <div class="tb-card">
                    <h4 class="tb-card__title">{% trans "Transfer Details" %}</h4>
                    <div class="tb-checkout-location">
                        <span class="tb-checkout-location__dot tb-checkout-location__dot--pickup"></span>
                        <span class="tb-checkout-location__text" id="tb-checkout-pickup-display">--</span>
                    </div>
                    <div class="tb-form-group" id="tb-checkout-flight-group" style="display:none;">
                        <label class="tb-label">{% trans "Flight Number" %}</label>
                        <input type="text" id="tb-checkout-flight" class="tb-input" placeholder="{% trans 'e.g. AT 1234' %}">
                    </div>
                    <div class="tb-checkout-row">
                        <div class="tb-form-group">
                            <label class="tb-label">{% trans "Date" %}</label>
                            <input type="date" id="tb-checkout-date-display" class="tb-input" disabled>
                        </div>
                        <div class="tb-form-group">
                            <label class="tb-label">{% trans "Time" %}</label>
                            <input type="time" id="tb-checkout-time-display" class="tb-input" disabled>
                        </div>
                    </div>
                    <div class="tb-checkout-location">
                        <span class="tb-checkout-location__dot tb-checkout-location__dot--dropoff"></span>
                        <span class="tb-checkout-location__text" id="tb-checkout-dropoff-display">--</span>
                    </div>
                    <div class="tb-form-group">
                        <label class="tb-label">{% trans "More details about the address" %}</label>
                        <input type="text" id="tb-special-requests" class="tb-input" placeholder="{% trans 'Hotel name, room number, etc.' %}">
                    </div>
                </div>
                <!-- Personal Information Card -->
                <div class="tb-card">
                    <h4 class="tb-card__title">{% trans "Personal Information" %}</h4>
                    <div class="tb-checkout-row">
                        <div class="tb-form-group">
                            <label class="tb-label" for="tb-customer-first-name">{% trans "First Name" %} *</label>
                            <input type="text" id="tb-customer-first-name" class="tb-input" placeholder="{% trans 'Enter your first name' %}">
                            <div class="tb-field-error" data-field="first-name"></div>
                        </div>
                        <div class="tb-form-group">
                            <label class="tb-label" for="tb-customer-last-name">{% trans "Last Name" %} *</label>
                            <input type="text" id="tb-customer-last-name" class="tb-input" placeholder="{% trans 'Enter your last name' %}">
                            <div class="tb-field-error" data-field="last-name"></div>
                        </div>
                    </div>
                    <div class="tb-form-group">
                        <label class="tb-label" for="tb-customer-email">{% trans "Email" %} *</label>
                        <input type="email" id="tb-customer-email" class="tb-input" placeholder="{% trans 'Enter your email' %}">
                        <div class="tb-field-error" data-field="email"></div>
                    </div>
                    <div class="tb-form-group">
                        <label class="tb-label" for="tb-customer-phone">{% trans "Phone Number" %} *</label>
                        <div class="tb-phone-input">
                            <div class="tb-phone-input__prefix">+212</div>
                            <input type="tel" id="tb-customer-phone" class="tb-phone-input__field" placeholder="">
                        </div>
                        <div class="tb-field-error" data-field="phone"></div>
                    </div>
                    <div class="tb-form-group">
                        <label class="tb-label">{% trans "WhatsApp Number" %}</label>
                        <div class="tb-phone-input">
                            <div class="tb-phone-input__prefix">+212</div>
                            <input type="tel" id="tb-customer-whatsapp" class="tb-phone-input__field" placeholder="">
                        </div>
                    </div>
                </div>
                <!-- Promo Code Card -->
                <div class="tb-card" id="tb-coupon-card">
                    <h4 class="tb-card__title">{% trans "Promo Code" %}</h4>
                    <div class="tb-coupon-input-row" id="tb-coupon-input-row" style="display:flex;gap:8px;">
                        <input type="text" id="tb-coupon-code" class="tb-input" placeholder="{% trans 'Enter code' %}">
                        <button type="button" id="tb-coupon-apply" class="tb-btn tb-btn--primary" style="padding:12px 20px;">{% trans "Apply" %}</button>
                    </div>
                    <div id="tb-coupon-success" style="display:none;background:rgba(16,185,129,0.1);color:#065f46;padding:10px 14px;border-radius:var(--tb-radius-sm);margin-top:8px;">
                        <span id="tb-coupon-message"></span>
                        <button type="button" id="tb-coupon-remove" style="background:none;border:none;color:var(--tb-error);cursor:pointer;margin-left:8px;font-weight:600;">{% trans "Remove" %}</button>
                    </div>
                    <div id="tb-coupon-error" class="tb-alert tb-alert--error" style="display:none;margin-top:8px;"></div>
                </div>
                <!-- Payment Card -->
                <div class="tb-card" id="tb-payment-card">
                    <h4 class="tb-card__title">{% trans "Payment" %}</h4>
                    <div id="tb-payment-errors" class="tb-alert tb-alert--error" style="display: none;"></div>
                    <div id="tb-gateways-container" class="tb-gateways-container">
                        <div class="tb-loading"><span class="tb-spinner"></span> {% trans "Loading payment methods..." %}</div>
                    </div>
                    <div id="tb-stripe-container" style="display:none;"><div id="tb-stripe-element"></div></div>
                    <div id="tb-paypal-container" style="display:none;"><p style="color:var(--tb-text-muted);font-size:0.9rem;text-align:center;padding:12px;">{% trans "You will be redirected to PayPal." %}</p></div>
                    <div id="tb-cash-container" style="display:none;"><p style="color:var(--tb-text-muted);font-size:0.9rem;text-align:center;padding:12px;">{% trans "Pay in cash to your driver." %}</p></div>
                    <button type="button" id="tb-pay-button" class="tb-btn tb-btn--primary tb-btn--full" style="display:none;">{% trans "Pay Now" %}</button>
                    <button type="button" id="tb-confirm-payment-btn" class="tb-btn tb-btn--primary tb-btn--full" style="display: none;">{% trans "Confirm Payment" %}</button>
                </div>
            </div>
            <!-- RIGHT: Gradient Summary Sidebar -->
            <div class="tb-step3-sidebar">
                <div class="tb-summary-gradient">
                    <div class="tb-summary-gradient__header">
                        <div class="tb-summary-gradient__icon">&#128663;</div>
                        <div>
                            <div class="tb-summary-gradient__vehicle-name" id="tb-order-vehicle">--</div>
                            <div class="tb-summary-gradient__vehicle-cap" id="tb-order-passengers">--</div>
                        </div>
                    </div>
                    <div class="tb-summary-gradient__stop">
                        <span class="tb-summary-gradient__dot"></span>
                        <span class="tb-summary-gradient__stop-text" id="tb-order-route-from">--</span>
                        <span class="tb-summary-gradient__stop-price" id="tb-order-base-price">--</span>
                    </div>
                    <div class="tb-summary-gradient__stop">
                        <span class="tb-summary-gradient__dot"></span>
                        <span class="tb-summary-gradient__stop-text" id="tb-order-route-to">--</span>
                    </div>
                    <div class="tb-summary-gradient__extras" id="tb-order-extras-list"></div>
                    <div id="tb-order-discount-row" style="display:none;">
                        <span id="tb-order-discount-label"></span>
                        <span id="tb-order-discount-value"></span>
                    </div>
                    <div class="tb-summary-gradient__total">
                        <span>{% trans "Total" %}</span>
                        <span id="tb-order-total">--</span>
                    </div>
                    <div class="tb-summary-gradient__deposit" id="tb-order-deposit-row" style="display:none;">
                        <span>{% trans "Deposit" %}</span>
                        <span id="tb-order-deposit">--</span>
                    </div>
                    <div class="tb-summary-gradient__deposit" id="tb-order-remaining-row" style="display:none;">
                        <span>{% trans "Remaining to driver" %}</span>
                        <span id="tb-order-remaining">--</span>
                    </div>
                </div>
                <!-- Hidden compat elements -->
                <div style="display:none;">
                    <span id="tb-order-route">--</span>
                    <span id="tb-order-datetime">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation -->
    <div id="tb-confirmation" class="tb-step">
        <div class="tb-confirmation">
            <div class="tb-confirmation__icon">&#10003;</div>
            <h2 class="tb-confirmation__title">{% trans "Booking Confirmed!" %}</h2>
            <p class="tb-confirmation__subtitle">{% trans "Your transfer has been successfully booked." %}</p>
            <div class="tb-confirmation__ref" id="tb-confirmation-ref">--</div>
            <p class="tb-confirmation__email">
                {% trans "Confirmation email sent to" %}<br>
                <strong id="tb-confirmation-email">--</strong>
            </p>
            <button type="button" id="tb-book-another" class="tb-btn tb-btn--primary">
                {% trans "Book Another Transfer" %}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Stripe.js -->
{% if site_settings and site_settings.stripe_publishable_key %}
<script src="https://js.stripe.com/v3/"></script>
{% endif %}

<!-- PayPal SDK -->
{% if site_settings and site_settings.paypal_client_id %}
<script src="https://www.paypal.com/sdk/js?client-id={{ site_settings.paypal_client_id }}&currency={{ site_settings.default_currency|default:'MAD' }}"></script>
{% endif %}

<!-- tbConfig: replaces the WP localized config -->
<script>
var tbConfig = {
    stripePublishableKey: '{{ site_settings.stripe_publishable_key|default:""|escapejs }}',
    paypalClientId: '{{ site_settings.paypal_client_id|default:""|escapejs }}',
    googleMapsApiKey: '{{ site_settings.google_maps_api_key|default:""|escapejs }}',
    currencySymbol: '{{ site_settings.default_currency|default:"MAD"|escapejs }}',
    currencyPosition: 'after',
    enableRoundTrip: true,
    enableFlightNumber: true,
    isRtl: false,
    lang: '{{ LANGUAGE_CODE|default:"en" }}',
    showNoRouteMessage: true,
    noRouteMessage: "{% trans 'This route is not currently available. Please contact us for a custom quote.' %}",
    contact: {
        phone: '{{ site_settings.contact_phone|default:""|escapejs }}',
        email: '{{ site_settings.contact_email|default:""|escapejs }}',
        whatsapp: '{{ site_settings.contact_whatsapp|default:""|escapejs }}'
    },
    transferTypes: [
        { value: 'airport_pickup',  label: "{% trans 'Airport Pickup' %}" },
        { value: 'airport_dropoff', label: "{% trans 'Airport Drop-off' %}" },
        { value: 'city_to_city',    label: "{% trans 'City to City' %}" },
        { value: 'port_transfer',   label: "{% trans 'Port Transfer' %}" }
    ],
    i18n: {
        selectPickup:       "{% trans 'Select pickup location' %}",
        selectDropoff:      "{% trans 'Select drop-off location' %}",
        selectType:         "{% trans 'Please select a transfer type' %}",
        selectDatetime:     "{% trans 'Please select date and time' %}",
        selectVehicle:      "{% trans 'Please select a vehicle' %}",
        required:           "{% trans 'This field is required' %}",
        invalidEmail:       "{% trans 'Please enter a valid email' %}",
        invalidPhone:       "{% trans 'Please enter a valid phone number' %}",
        loading:            "{% trans 'Loading...' %}",
        processing:         "{% trans 'Processing...' %}",
        noVehicles:         "{% trans 'No vehicles available for this route.' %}",
        errorGeneric:       "{% trans 'Something went wrong. Please try again.' %}",
        paymentFailed:      "{% trans 'Payment failed. Please try again.' %}",
        distance:           "{% trans 'Distance' %}",
        duration:           "{% trans 'Est. Duration' %}",
        passengers:         "{% trans 'passengers' %}",
        bags:               "{% trans 'bags' %}",
        totalPrice:         "{% trans 'total price' %}",
        perItem:            "{% trans '/each' %}",
        returnDateRequired: "{% trans 'Return date is required for round trips' %}",
        minBookingTime:     "{% trans 'We can only accept bookings for this route with a minimum of {hours} hours notice.' %}",
        oneWay:             "{% trans 'One-way' %}",
        roundTrip:          "{% trans 'Round trip' %}",
        multiCity:          "{% trans 'Multi-city' %}",
        addReturn:          "{% trans 'Add return' %}",
        addTransfer:        "{% trans 'Add another transfer' %}",
        swapLocations:      "{% trans 'Swap locations' %}",
        transferOf:         "{% trans 'Transfer {current} of {total}' %}",
        allTransfersBooked: "{% trans 'All transfers booked!' %}",
        luggage:            "{% trans 'Luggage' %}",
        from:               "{% trans 'From' %}",
        to:                 "{% trans 'To' %}",
        departure:          "{% trans 'Departure' %}",
        returnToStart:      "{% trans 'Return to start' %}",
        selectPayment:      "{% trans 'Please select a payment method' %}",
        payFull:            "{% trans 'Pay full amount' %}",
        payDeposit:         "{% trans 'Pay deposit' %}",
        depositOnly:        "{% trans 'deposit' %}",
        remainingToDriver:  "{% trans 'Remaining to driver' %}",
        toDriver:           "{% trans 'to driver' %}",
        payCash:            "{% trans 'Pay Cash to Driver' %}",
        cashDescription:    "{% trans 'Pay the full amount to your driver in cash' %}",
        payWithPaypal:      "{% trans 'Pay with PayPal' %}",
        paypalInfo:         "{% trans 'You will be redirected to PayPal to complete payment.' %}",
        apply:              "{% trans 'Apply' %}",
        discount:           "{% trans 'Discount' %}",
        invalidCoupon:      "{% trans 'Invalid coupon code' %}",
        couponApplied:      "{% trans 'Coupon applied' %}",
        removeCoupon:       "{% trans 'Remove' %}",
        payNow:             "{% trans 'Pay Now' %}",
        depositBreakdown:   "{% trans 'Deposit' %}",
        remainingAmount:    "{% trans 'Remaining' %}"
    }
};
</script>

<!-- API endpoints mapping (replaces WP AJAX proxy) -->
<script>
var TB_API_ENDPOINTS = {
    google_maps_config: { method: 'GET',  path: '/api/v1/locations/google-maps-config/' },
    get_pricing:        { method: 'GET',  path: '/api/v1/locations/routes/get_pricing/' },
    get_extras:         { method: 'GET',  path: '/api/v1/transfers/extras/' },
    get_categories:     { method: 'GET',  path: '/api/v1/vehicles/categories/' },
    get_quote:          { method: 'POST', path: '/api/v1/transfers/quote/' },
    create_booking:     { method: 'POST', path: '/api/v1/transfers/' },
    create_payment:     { method: 'POST', path: '/api/v1/payments/' },
    confirm_payment:    { method: 'POST', path: '/api/v1/payments/confirm/' },
    get_gateways:       { method: 'GET',  path: '/api/v1/payments/gateways/' },
    validate_coupon:    { method: 'POST', path: '/api/v1/payments/coupons/validate/' }
};
</script>

<!-- tb-utils.js -->
<script>
(function () {
    'use strict';
    window.TB = window.TB || {};
    TB.Utils = {
        formatPrice: function (amount, currency, position) {
            currency = currency || tbConfig.currencySymbol;
            position = position || tbConfig.currencyPosition;
            var num = Math.round(parseFloat(amount));
            if (isNaN(num)) return '--';
            if (position === 'before') return currency + ' ' + num;
            return num + ' ' + currency;
        },
        formatDate: function (dateStr) {
            if (!dateStr) return '--';
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        },
        formatDateTime: function (dateStr) {
            if (!dateStr) return '--';
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' ' +
                   d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        },
        formatDuration: function (minutes) {
            if (!minutes) return '--';
            var h = Math.floor(minutes / 60);
            var m = minutes % 60;
            if (h > 0 && m > 0) return h + 'h ' + m + 'min';
            if (h > 0) return h + 'h';
            return m + ' min';
        },
        shortName: function (name) {
            if (!name) return '--';
            return name.split(',')[0].trim();
        },
        validateEmail: function (email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); },
        validatePhone: function (phone) { return /^[\+]?[\d\s\-()]{8,}$/.test(phone); },
        escapeHtml: function (str) {
            if (!str) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        },
        showFieldError: function (field, message) {
            var el = document.querySelector('.tb-field-error[data-field="' + field + '"]');
            if (el) el.textContent = message;
            var input = el ? el.previousElementSibling : null;
            if (input && input.classList) input.classList.add('tb-input--error');
        },
        clearFieldErrors: function () {
            var errors = document.querySelectorAll('.tb-field-error');
            for (var i = 0; i < errors.length; i++) errors[i].textContent = '';
            var inputs = document.querySelectorAll('.tb-input--error');
            for (var j = 0; j < inputs.length; j++) inputs[j].classList.remove('tb-input--error');
        },
        showAlert: function (containerId, message) {
            var el = document.getElementById(containerId);
            if (el) { el.textContent = message; el.style.display = 'block'; }
        },
        hideAlert: function (containerId) {
            var el = document.getElementById(containerId);
            if (el) el.style.display = 'none';
        },
        setButtonLoading: function (btn, loading) {
            if (!btn) return;
            if (loading) {
                btn._origText = btn.textContent;
                btn.innerHTML = '<span class="tb-spinner"></span> ' + tbConfig.i18n.processing;
                btn.classList.add('tb-btn--loading');
                btn.disabled = true;
            } else {
                btn.textContent = btn._origText || '';
                btn.classList.remove('tb-btn--loading');
                btn.disabled = false;
            }
        }
    };
})();
</script>

<!-- tb-api.js (modified: direct REST calls instead of WP AJAX proxy) -->
<script>
(function () {
    'use strict';
    window.TB = window.TB || {};

    function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    TB.API = {
        _call: function (endpoint, params) {
            return new Promise(function (resolve, reject) {
                var config = TB_API_ENDPOINTS[endpoint];
                if (!config) {
                    reject({ message: 'Unknown endpoint: ' + endpoint });
                    return;
                }

                var url = config.path;
                var options = {
                    method: config.method,
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                };

                if (config.method === 'GET' && params) {
                    var qs = Object.keys(params).map(function (k) {
                        return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
                    }).join('&');
                    if (qs) url += '?' + qs;
                } else if (config.method === 'POST' && params) {
                    options.headers['Content-Type'] = 'application/json';
                    var csrfToken = getCookie('csrftoken');
                    if (csrfToken) {
                        options.headers['X-CSRFToken'] = csrfToken;
                    }
                    options.body = JSON.stringify(params);
                }

                fetch(url, options)
                    .then(function (response) {
                        if (!response.ok) {
                            return response.json().then(function (data) {
                                var msg = data.message || data.error || data.detail || tbConfig.i18n.errorGeneric;
                                reject({ message: msg, data: data });
                            }).catch(function () {
                                reject({ message: 'HTTP ' + response.status });
                            });
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        if (data !== undefined) resolve(data);
                    })
                    .catch(function (err) {
                        if (!err.message || err.message.indexOf('HTTP') === -1) {
                            reject({ message: err.message || tbConfig.i18n.errorGeneric });
                        }
                    });
            });
        },

        getGoogleMapsConfig: function () { return this._call('google_maps_config'); },
        getPricing: function (originLat, originLng, destLat, destLng, passengers) {
            return this._call('get_pricing', {
                origin_lat: originLat, origin_lng: originLng,
                destination_lat: destLat, destination_lng: destLng,
                passengers: passengers
            });
        },
        getExtras: function () { return this._call('get_extras'); },
        getCategories: function () { return this._call('get_categories'); },
        getQuote: function (quoteData) { return this._call('get_quote', quoteData); },
        createBooking: function (bookingData) { return this._call('create_booking', bookingData); },
        createPayment: function (paymentData) {
            if (typeof paymentData === 'number' || typeof paymentData === 'string') {
                // Legacy: createPayment(bookingId, gatewayType)
                var bookingId = paymentData;
                var gatewayType = arguments[1] || 'stripe';
                paymentData = {
                    booking_type: 'transfer',
                    booking_id: bookingId,
                    gateway_type: gatewayType
                };
            }
            return this._call('create_payment', paymentData);
        },
        confirmPayment: function (paymentRef) {
            return this._call('confirm_payment', { payment_ref: paymentRef });
        },
        getGateways: function () { return this._call('get_gateways'); },
        validateCoupon: function (data) { return this._call('validate_coupon', data); }
    };
})();
</script>

<!-- tb-state.js -->
<script>
(function () {
    'use strict';
    window.TB = window.TB || {};
    var STORAGE_KEY = 'tb_booking_state';
    var defaultLeg = {
        pickupAddress: '', pickupLat: null, pickupLng: null,
        dropoffAddress: '', dropoffLat: null, dropoffLng: null,
        pickupDatetime: '', transferType: '', flightNumber: '',
        pricingData: null, vehicleOptions: [], selectedVehicle: null,
        selectedExtras: [], quoteData: null, bookingId: null,
        bookingRef: '', paymentRef: '', totalPrice: 0
    };
    var defaults = {
        step: 1, mode: 'one-way', currentLegIndex: 0,
        legs: [JSON.parse(JSON.stringify(defaultLeg))],
        /* flat fields kept for backward compat with Steps 2/3 */
        transferType: '', pickupAddress: '', pickupLat: null, pickupLng: null,
        dropoffAddress: '', dropoffLat: null, dropoffLng: null, pickupDatetime: '',
        passengers: 1, luggage: 1, isRoundTrip: false, returnDatetime: '', flightNumber: '',
        pricingData: null, vehicleOptions: [], selectedVehicle: null, extras: [],
        selectedExtras: [], quoteData: null, customerName: '', customerEmail: '',
        customerPhone: '', specialRequests: '', bookingId: null, bookingRef: '',
        paymentRef: '', totalPrice: 0, currency: 'MAD'
    };
    var _data = {};
    function cloneDefaults() { return JSON.parse(JSON.stringify(defaults)); }
    TB.State = {
        get: function (key) { return _data.hasOwnProperty(key) ? _data[key] : null; },
        set: function (key, value) { _data[key] = value; },
        getAll: function () { return JSON.parse(JSON.stringify(_data)); },
        save: function () { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(_data)); } catch (e) {} },
        load: function () {
            try {
                var saved = localStorage.getItem(STORAGE_KEY);
                if (saved) { _data = Object.assign(cloneDefaults(), JSON.parse(saved)); }
                else { _data = cloneDefaults(); }
            } catch (e) { _data = cloneDefaults(); }
            // Ensure legs array exists (for older saved states)
            if (!_data.legs || !_data.legs.length) {
                _data.legs = [JSON.parse(JSON.stringify(defaultLeg))];
            }
        },
        reset: function () { _data = cloneDefaults(); try { localStorage.removeItem(STORAGE_KEY); } catch (e) {} },
        syncLegToFlat: function (idx) {
            var legs = _data.legs || [];
            var leg = legs[idx];
            if (!leg) return;
            _data.transferType = leg.transferType || '';
            _data.pickupAddress = leg.pickupAddress || '';
            _data.pickupLat = leg.pickupLat;
            _data.pickupLng = leg.pickupLng;
            _data.dropoffAddress = leg.dropoffAddress || '';
            _data.dropoffLat = leg.dropoffLat;
            _data.dropoffLng = leg.dropoffLng;
            _data.pickupDatetime = leg.pickupDatetime || '';
            _data.flightNumber = leg.flightNumber || '';
            // Reset step 2/3 selections for new leg
            _data.pricingData = leg.pricingData || null;
            _data.vehicleOptions = leg.vehicleOptions || [];
            _data.selectedVehicle = leg.selectedVehicle || null;
            _data.selectedExtras = leg.selectedExtras || [];
            _data.quoteData = leg.quoteData || null;
            _data.bookingId = leg.bookingId || null;
            _data.bookingRef = leg.bookingRef || '';
            _data.paymentRef = leg.paymentRef || '';
            _data.totalPrice = leg.totalPrice || 0;
        },
        saveFlatToLeg: function (idx) {
            var legs = _data.legs || [];
            if (!legs[idx]) return;
            legs[idx].transferType = _data.transferType;
            legs[idx].pickupAddress = _data.pickupAddress;
            legs[idx].pickupLat = _data.pickupLat;
            legs[idx].pickupLng = _data.pickupLng;
            legs[idx].dropoffAddress = _data.dropoffAddress;
            legs[idx].dropoffLat = _data.dropoffLat;
            legs[idx].dropoffLng = _data.dropoffLng;
            legs[idx].pickupDatetime = _data.pickupDatetime;
            legs[idx].flightNumber = _data.flightNumber;
            legs[idx].pricingData = _data.pricingData;
            legs[idx].vehicleOptions = _data.vehicleOptions;
            legs[idx].selectedVehicle = _data.selectedVehicle;
            legs[idx].selectedExtras = _data.selectedExtras;
            legs[idx].quoteData = _data.quoteData;
            legs[idx].bookingId = _data.bookingId;
            legs[idx].bookingRef = _data.bookingRef;
            legs[idx].paymentRef = _data.paymentRef;
            legs[idx].totalPrice = _data.totalPrice;
            _data.legs = legs;
        }
    };
    TB.State.load();
})();
</script>

<!-- tb-step1.js -->
<script>
{% include "dashboard/booking_form_step1.js" %}
</script>

<!-- tb-step2.js -->
<script>
{% include "dashboard/booking_form_step2.js" %}
</script>

<!-- tb-step3.js -->
<script>
{% include "dashboard/booking_form_step3.js" %}
</script>

<!-- tb-wizard.js -->
<script>
(function () {
    'use strict';
    window.TB = window.TB || {};
    TB.Wizard = {
        currentStep: 1,
        init: function () {
            TB.State.set('step', 1);
            this.currentStep = 1;
            this.showStep(1);
            TB.Step1.init();
            var bookAnother = document.getElementById('tb-book-another');
            if (bookAnother) {
                bookAnother.addEventListener('click', function () { TB.Wizard.resetAndRestart(); });
            }
        },
        showStep: function (step) {
            var steps = document.querySelectorAll('.tb-step');
            for (var i = 0; i < steps.length; i++) steps[i].classList.remove('tb-step--active');
            var target = document.getElementById('tb-step-' + step);
            if (target) target.classList.add('tb-step--active');
            this.updateProgress(step);
            this.currentStep = step;
            TB.State.set('step', step);
            if (step === 2) TB.Step2.init();
            if (step === 3) TB.Step3.init();
            var widget = document.getElementById('tb-booking-widget');
            if (widget) widget.scrollIntoView({ behavior: 'smooth', block: 'start' });
        },
        updateProgress: function (step) {
            var progressSteps = document.querySelectorAll('.tb-progress__step');
            for (var i = 0; i < progressSteps.length; i++) {
                var stepNum = parseInt(progressSteps[i].getAttribute('data-step'));
                progressSteps[i].classList.remove('tb-progress__step--active', 'tb-progress__step--completed');
                if (stepNum === step) progressSteps[i].classList.add('tb-progress__step--active');
                else if (stepNum < step) progressSteps[i].classList.add('tb-progress__step--completed');
            }
            // Multi-city progress indicator
            var multiProgress = document.getElementById('tb-multi-progress');
            if (multiProgress) {
                var mode = TB.State.get('mode');
                if (mode === 'multi-city' && step > 1) {
                    var legs = TB.State.get('legs') || [];
                    var currentIdx = TB.State.get('currentLegIndex') || 0;
                    var text = (tbConfig.i18n.transferOf || 'Transfer {current} of {total}')
                        .replace('{current}', currentIdx + 1)
                        .replace('{total}', legs.length);
                    multiProgress.textContent = text;
                    multiProgress.style.display = 'block';
                } else {
                    multiProgress.style.display = 'none';
                }
            }
        },
        showConfirmation: function () {
            var steps = document.querySelectorAll('.tb-step');
            for (var i = 0; i < steps.length; i++) steps[i].classList.remove('tb-step--active');
            var confirmEl = document.getElementById('tb-confirmation');
            if (confirmEl) confirmEl.classList.add('tb-step--active');
            var progressSteps = document.querySelectorAll('.tb-progress__step');
            for (var j = 0; j < progressSteps.length; j++) {
                progressSteps[j].classList.remove('tb-progress__step--active');
                progressSteps[j].classList.add('tb-progress__step--completed');
            }
            var multiProgress = document.getElementById('tb-multi-progress');
            if (multiProgress) multiProgress.style.display = 'none';
            var widget = document.getElementById('tb-booking-widget');
            if (widget) widget.scrollIntoView({ behavior: 'smooth', block: 'start' });
        },
        onLegComplete: function () {
            var mode = TB.State.get('mode');
            var currentIdx = TB.State.get('currentLegIndex') || 0;
            var legs = TB.State.get('legs') || [];

            // Save Step 2/3 results back to current leg
            TB.State.saveFlatToLeg(currentIdx);
            TB.State.save();

            if (mode === 'multi-city' && currentIdx < legs.length - 1) {
                // More legs remain — advance to next
                var nextIdx = currentIdx + 1;
                TB.State.set('currentLegIndex', nextIdx);
                TB.State.syncLegToFlat(nextIdx);
                // Reset step 2/3 UI selections
                TB.State.set('selectedVehicle', null);
                TB.State.set('selectedExtras', []);
                TB.State.set('quoteData', null);
                TB.State.save();
                // Show Step 2 for next leg
                this.showStep(2);
            } else if (mode === 'multi-city') {
                // All legs done — show multi-city confirmation
                this.showMultiCityConfirmation();
            } else {
                // Single leg — show normal confirmation
                var refEl = document.getElementById('tb-confirmation-ref');
                var emailEl = document.getElementById('tb-confirmation-email');
                if (refEl) refEl.textContent = TB.State.get('bookingRef');
                if (emailEl) emailEl.textContent = TB.State.get('customerEmail');
                this.showConfirmation();
            }
        },
        showMultiCityConfirmation: function () {
            var legs = TB.State.get('legs') || [];
            var refs = [];
            for (var i = 0; i < legs.length; i++) {
                if (legs[i].bookingRef) refs.push(legs[i].bookingRef);
            }
            var refEl = document.getElementById('tb-confirmation-ref');
            var emailEl = document.getElementById('tb-confirmation-email');
            if (refEl) refEl.textContent = refs.join(', ');
            if (emailEl) emailEl.textContent = TB.State.get('customerEmail');
            this.showConfirmation();
        },
        resetAndRestart: function () {
            TB.State.reset();
            var inputs = document.querySelectorAll('#tb-booking-widget input, #tb-booking-widget select, #tb-booking-widget textarea');
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type === 'checkbox') inputs[i].checked = false;
                else if (inputs[i].type === 'number') inputs[i].value = inputs[i].getAttribute('value') || '1';
                else if (inputs[i].tagName === 'SELECT') inputs[i].selectedIndex = 0;
                else inputs[i].value = '';
            }
            var flightBar = document.getElementById('tb-flight-bar');
            if (flightBar) flightBar.style.display = 'none';
            var multiProgress = document.getElementById('tb-multi-progress');
            if (multiProgress) multiProgress.style.display = 'none';
            // Clear multi-city state
            var legsContainer = document.getElementById('tb-legs-container');
            if (legsContainer) legsContainer.innerHTML = '';
            var returnCheck = document.getElementById('tb-return-to-start-check');
            if (returnCheck) returnCheck.checked = false;
            var returnToggle = document.getElementById('tb-return-to-start');
            if (returnToggle) returnToggle.style.display = 'none';
            // Reset mode tabs to one-way
            var tabs = document.querySelectorAll('.tb-mode-tab');
            for (var t = 0; t < tabs.length; t++) {
                tabs[t].classList.toggle('tb-mode-tab--active', tabs[t].getAttribute('data-mode') === 'one-way');
            }
            var singleBar = document.getElementById('tb-single-bar');
            if (singleBar) singleBar.style.display = 'block';
            var multiBar = document.getElementById('tb-multi-bar');
            if (multiBar) multiBar.style.display = 'none';
            // Reset pax/luggage display
            var paxCount = document.getElementById('tb-pax-count');
            var lugCount = document.getElementById('tb-luggage-count');
            if (paxCount) paxCount.textContent = '1';
            if (lugCount) lugCount.textContent = '1';
            var pillText = document.getElementById('tb-pax-pill-text');
            if (pillText) pillText.textContent = '1 pax, 1 bag';
            var pillTextMulti = document.getElementById('tb-pax-pill-text-multi');
            if (pillTextMulti) pillTextMulti.textContent = '1 pax, 1 bag';
            this.showStep(1);
            TB.Step1.init();
        }
    };
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('tb-booking-widget')) TB.Wizard.init();
    });
})();
</script>
{% endblock %}
